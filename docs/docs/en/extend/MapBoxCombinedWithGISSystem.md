---
title: Use of mxdraw and mapbox
author: mxcad
date: '2022-8-16'
---

## How are mapbox maps and cad drawings displayed together?

mapbox is an interactive map rendered via webgl, while mxdraw is also implemented using webgl rendering.

So we can use the custom layer provided by mapbox and mxdraw control instance rendering, the cad layer and map display.

If you don't know Chinese mapbox can refer to [official documentation](http://www.mapbox.cn/mapbox-gl-js/api/)/[international standing](https://www.mapbox.com/)

The following code is a minimalist example of mapbox and mxdraw combined.


```sh

# Install the corresponding dependency package first

npm install mapbox-gl mxdraw
```

``` html

<div id="map"></div>

```

``` js

import mapboxgl from "mapbox-gl";
import Mx from "mxdraw"
import * as THREE from "three"

// You need to apply for the token on the mapbox official website
mapboxgl.accessToken = "pk.eyJ1IjoibWFvcmV5IiwiYSI6ImNqNWhrenIwcDFvbXUyd3I2bTJxYzZ4em8ifQ.KHZIehQuWW9AsMaGtATdwA"

// Longitude and latitude of Beijing location
const center = [116.391305, 39.90553]

const map = new mapboxgl.Map({
    // Mapbox GL JS renders the HTML element of the map, or the string id of that element. This specified element cannot have child elements.
    container: 'map',
    // Map location
    center,
    // Map style
    style: 'mapbox://styles/mapbox/streets-v11',
    zoom: 16
})

// The height of the drawing or model
const modelAltitude = 100;

// Convert LngLat projection to Mercator projection coordinates
const point = mapboxgl.MercatorCoordinate.fromLngLat(
    center,
    modelAltitude
);
// Returns the distance of 1 meter expressed in Mercator coordinates at this latitude.
// For real-world coordinates that use meters, this naturally provides a scale that is converted to Mercator projection coordinates
const lDistForM = point.meterInMercatorCoordinateUnits();

// It is currently decided that the range of the cad drawing in reality is 1 km
const lCADArea = 1000 * lDistForM * 1;

// Provides some of the necessary mapbox information, and gives some of the core methods that mxdraw provides
let mxMap = {
    // canvas element generated by mapbox
    canvas: null,
    // Customize the gl context provided by the layer
    gl: void 0,
    // Location of cad drawing 1
    cadLocation1: new THREE.Vector3(),
    // Location of cad drawing 2
    cadLocation2: new THREE.Vector3(),
    // Altitude
    elevation: 0,
    // Customize layer information
    customLayer: {},
    // cad drawing control object
    mxObj: null,
    // Coordinate transformation matrix 1
    matCadToMap: new THREE.Matrix4(),
    // Coordinate transformation matrix 1
    matMapToCad: new THREE.Matrix4(),
    // Customize the layer matrix
    matrix: undefined,
    // Render function
    render(gl, matrix){

    },
    // Method of interconversion of coordinate system
    cadToMercatorCoord(pt) {
        pt.applyMatrix4(this.matCadToMap);
        return new mapboxgl.MercatorCoordinate(pt.x,pt.y,pt.z); 
    },
    
    mercatorCoordToCad(pt){
        let ptRet = new THREE.Vector3(pt.x,pt.y,pt.z);
        ptRet.applyMatrix4(this.matMapToCad);
        return ptRet; 
    },

    cadLongToMercatorCoord(len){
        let pt1 = new THREE.Vector3(0,0,0);
        let pt2 = new THREE.Vector3(len,0,0);
        pt1.applyMatrix4(this.matCadToMap);
        pt2.applyMatrix4(this.matCadToMap);
        return pt1.distanceTo(pt2);
    }

}
// Through the above information to determine the specific position on the cad diagram
mxMap.cadLocation1 = new THREE.Vector3(point.x - lCADArea / 2, point.y - lCADArea, point.z);
mxMap.cadLocation2 = new THREE.Vector3(point.x + lCADArea, point.y + lCADArea / 2, point.z);

// New mapbox custom layer
const customLayer = {
    id: "3d-model", // Any ID that does not duplicate
    type: "custom",
    renderingMode: "3d",
    async onAdd(map, gl) {
        // Load the mxdraw core library synchronously
        await Mx.loadCoreCode()
        // Get the canvas element of mapbox
        mxMap.canvas = map.getCanvas();
        // and webgl context
        mxMap.gl = gl
        // Create a drawing control object
        Mx.MxFun.createMxObject({
            // mapBox provides some necessary parameters for mapbox
            mapBox: mxMap,
            // To open the drawing
            cadFile: "../../demo/buf/$hhhh.dwg",
            callback: (mxObj) => {
                mxMap.mxObj = mxObj;
                mxObj.addEvent("loadComplete", () => {
                    // Update mapbox
                    map.triggerRepaint()
                });
            }
        }); 
  
    },
    render(gl, matrix) {

        // Assignment matrix information
        mxMap.matrix = matrix
        // A rendering function is provided to update the drawing after it is created
        mxMap.render(gl, matrix);

        // Refresh mapbox
        map.triggerRepaint()
    }
};
// Assigns the information for this custom layer
mxMap.customLayer = customLayer
// Add a custom layer
map.on('style.load', ()=> {
    map.addLayer(customLayer)
})
```

Effect:  
<demo :url="$withBase('/samples/GIS/mapboxOrMxdraw.html')" /> 